<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DINAMIS BPS - Mood Polling (Sheets Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F8FAFC;
        }

        .mood-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .mood-card:hover {
            transform: translateY(-10px) scale(1.02);
        }

        .mood-card:active {
            transform: scale(0.95);
        }

        .header-gradient {
            background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.1), transparent),
                        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.05), transparent);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="text-slate-900 pb-20 relative min-h-screen header-gradient">

    <!-- Konfigurasi Warning -->
    <div id="setupWarning" class="fixed top-4 left-4 right-4 z-[200] bg-amber-500 text-white p-4 rounded-2xl shadow-xl flex items-center justify-between hidden">
        <div class="flex items-center gap-3">
            <i data-lucide="help-circle"></i>
            <p class="text-xs font-bold">Gagal mengambil data. Pastikan URL Script benar dan di-deploy sebagai 'Anyone'.</p>
        </div>
        <button onclick="this.parentElement.remove()" class="p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <!-- Success Overlay -->
    <div id="successOverlay" class="fixed inset-0 z-[100] hidden flex flex-col items-center justify-center bg-white/95 backdrop-blur-xl">
        <div class="relative text-center space-y-8 p-12">
            <div id="successEmojiDisplay" class="text-9xl animate-float drop-shadow-2xl">ü§©</div>
            <div class="space-y-3">
                <h3 class="text-4xl font-black text-slate-900 tracking-tighter italic uppercase">BERHASIL!</h3>
                <p class="text-slate-500 font-bold text-lg text-sync-status">Menyimpan ke Google Sheets...</p>
            </div>
            <div class="w-16 h-1 bg-emerald-500 mx-auto rounded-full"></div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="max-w-5xl mx-auto px-6 pt-12 md:pt-20 space-y-16">
        
        <!-- Header -->
        <header class="text-center space-y-6">
            <div class="space-y-2">
                <div class="inline-block relative">
                    <h1 class="text-7xl md:text-9xl font-black tracking-tighter text-slate-950 leading-none">DINAMIS</h1>
                    <span class="absolute -bottom-1 -right-2 bg-indigo-600 text-white text-[10px] md:text-xs font-black px-3 py-1 rounded-full rotate-2 shadow-lg">BPS 1902</span>
                </div>
                <p class="text-slate-400 font-bold italic text-sm md:text-lg tracking-tight pt-4">"Dinamika Mingguan Internal Pegawai BPS"</p>
            </div>
        </header>

        <!-- Polling Section -->
        <section id="pollingView" class="bg-white p-8 md:p-16 rounded-[4rem] shadow-2xl shadow-indigo-900/5 border border-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-full -mr-32 -mt-32 opacity-50"></div>
            <div class="relative z-10 space-y-12">
                <div class="space-y-6 max-w-2xl">
                    <h2 class="text-3xl md:text-5xl font-black text-slate-900 tracking-tight leading-[1.1]">Yuk, share cerita kerja kamu minggu ini üëã</h2>
                    <div class="space-y-1">
                        <p class="text-slate-500 font-bold text-base md:text-xl flex items-center gap-2">
                            <span>Cukup singkat ‚úçÔ∏è, santai üòä, dan anonim üîí</span>
                        </p>
                        <p class="text-indigo-600 font-semibold text-sm md:text-base italic">
                            Partisipasi kamu bantu kita jaga ritme kerja bersama ü§ù
                        </p>
                    </div>
                </div>

                <div id="moodGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6">
                    <!-- Dinamis oleh JS -->
                </div>
            </div>
        </section>

        <!-- Voted State -->
        <section id="votedView" class="hidden bg-indigo-600 p-10 md:p-16 rounded-[4rem] text-white flex flex-col md:flex-row items-center justify-between gap-10 shadow-2xl shadow-indigo-600/30">
            <div class="space-y-4 text-center md:text-left">
                <h3 class="text-4xl font-black italic uppercase tracking-tighter leading-none">Selesai!</h3>
                <p class="text-indigo-100 font-bold text-lg opacity-80">Terima kasih atas partisipasi Anda.</p>
                <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-white/20 hover:bg-white/30 rounded-xl text-xs font-bold transition-all border border-white/30">Kirim Lagi</button>
            </div>
            <div id="votedEmojiDisplay" class="text-8xl animate-float"></div>
        </section>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-8 rounded-[3rem] border border-white shadow-sm flex items-center gap-6">
                <div class="p-5 bg-indigo-50 text-indigo-600 rounded-[2rem]"><i data-lucide="users-2"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Masuk</p>
                    <p id="statTotalVotes" class="text-3xl font-black text-slate-900">0</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[3rem] border border-white shadow-sm flex items-center gap-6">
                <div class="p-5 bg-emerald-50 text-emerald-600 rounded-[2rem]"><i data-lucide="refresh-cw"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Update Terakhir</p>
                    <p id="statLastUpdate" class="text-sm font-black text-slate-900">Menunggu...</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[3rem] border border-white shadow-sm flex items-center gap-6">
                <div class="p-5 bg-amber-50 text-amber-600 rounded-[2rem]"><i data-lucide="database"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Penyimpanan</p>
                    <p class="text-xl font-black text-slate-900 uppercase">G-Sheets</p>
                </div>
            </div>
        </div>

        <!-- Analytics -->
        <section class="bg-white p-10 md:p-16 rounded-[4rem] shadow-2xl shadow-indigo-900/5 border border-white">
            <div class="flex items-center gap-6 mb-12">
                <div class="p-5 bg-slate-950 text-white rounded-3xl shadow-xl rotate-3"><i data-lucide="bar-chart-big"></i></div>
                <div class="text-center md:text-left">
                    <h2 class="text-3xl font-black text-slate-900 tracking-tight">Ringkasan Mood</h2>
                    <p class="text-sm font-bold text-slate-400 italic">Data ditarik langsung dari tabel</p>
                </div>
            </div>
            <div class="h-[400px] w-full">
                <canvas id="moodChart"></canvas>
            </div>
        </section>

    </div>

    <script>
        // Gunakan URL Web App dari Google Script Anda
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_gy-pVOg7AqWvw840omAufQ1tuzyGpfTLhbBabtKTrycVvOX8T7dTSq-o_v1ORfBr/exec";

        const MOOD_OPTIONS = [
            { id: 'excited', label: 'Semangat', emoji: 'ü§©', color: '#FBBF24' },
            { id: 'good', label: 'Senang', emoji: 'üòä', color: '#10B981' },
            { id: 'neutral', label: 'Biasa', emoji: 'üòê', color: '#64748B' },
            { id: 'tired', label: 'Lelah', emoji: 'üò´', color: '#3B82F6' },
            { id: 'burnout', label: 'Stress', emoji: 'ü§Ø', color: '#EF4444' }
        ];

        let chartInstance = null;

        window.onload = () => {
            lucide.createIcons();
            renderMoodCards();
            refreshData(); 
        };

        function renderMoodCards() {
            const container = document.getElementById('moodGrid');
            if (!container) return;
            container.innerHTML = MOOD_OPTIONS.map(m => `
                <button onclick="voteMood('${m.id}')" class="mood-card group flex flex-col items-center justify-center p-8 md:p-10 rounded-[2.5rem] bg-slate-50 border-2 border-slate-100 hover:bg-white hover:border-indigo-500 hover:shadow-2xl transition-all">
                    <span class="text-6xl md:text-7xl mb-6 group-hover:scale-125 transition-transform duration-500">${m.emoji}</span>
                    <span class="block text-sm md:text-base font-black text-slate-800 uppercase tracking-tighter">${m.label}</span>
                </button>
            `).join('');
        }

        async function voteMood(moodId) {
            const mood = MOOD_OPTIONS.find(m => m.id === moodId);
            document.getElementById('successEmojiDisplay').innerText = mood.emoji;
            document.getElementById('successOverlay').classList.remove('hidden');

            try {
                // Mengirim data menggunakan mode no-cors untuk POST
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'addVote',
                        moodId: mood.id,
                        label: mood.label,
                        timestamp: new Date().toLocaleString('id-ID')
                    })
                });

                setTimeout(() => {
                    document.getElementById('successOverlay').classList.add('hidden');
                    document.getElementById('pollingView').classList.add('hidden');
                    document.getElementById('votedView').classList.remove('hidden');
                    document.getElementById('votedEmojiDisplay').innerText = mood.emoji;
                    refreshData(); 
                }, 1500);

            } catch (err) {
                console.error("Error voting:", err);
                document.getElementById('successOverlay').classList.add('hidden');
            }
        }

        async function refreshData() {
            if (!SCRIPT_URL || SCRIPT_URL.includes("MASUKKAN")) return;

            try {
                // Pastikan menggunakan URL yang benar dan redirect follow
                const fetchUrl = `${SCRIPT_URL}?action=getStats&t=${new Date().getTime()}`;
                
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) throw new Error('Fetch stats failed');
                
                const stats = await response.json();
                
                document.getElementById('statTotalVotes').innerText = stats.total || 0;
                document.getElementById('statLastUpdate').innerText = new Date().toLocaleTimeString('id-ID');
                
                updateChart(stats.counts || {});
            } catch (err) {
                console.error("Gagal ambil data (G-Sheets):", err);
                document.getElementById('setupWarning').classList.remove('hidden');
                updateChart({});
            }
        }

        function updateChart(counts) {
            const chartCanvas = document.getElementById('moodChart');
            if (!chartCanvas) return;
            
            const ctx = chartCanvas.getContext('2d');
            const dataValues = MOOD_OPTIONS.map(m => counts[m.id] || 0);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: MOOD_OPTIONS.map(m => m.label),
                    datasets: [{
                        label: 'Jumlah Mood',
                        data: dataValues,
                        backgroundColor: MOOD_OPTIONS.map(m => m.color),
                        borderRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { weight: 'bold' } } }
                    }
                }
            });
        }
    </script>
</body>
</html>
