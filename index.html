<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DINAMIS BPS - Mood Polling (Sheets Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F8FAFC;
        }

        .mood-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .mood-card:hover {
            transform: translateY(-10px) scale(1.02);
        }

        .mood-card:active {
            transform: scale(0.9);
        }

        .header-gradient {
            background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.1), transparent),
                        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.05), transparent);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        /* Transitions */
        .page-transition {
            transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .fade-out {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.8s forwards cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .admin-fab-menu {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: bottom right;
        }

        .fab-hidden {
            transform: scale(0) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }

        .glass-modal {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chart-toggle-active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .credit-line {
            height: 1px;
            background: linear-gradient(to right, transparent, #e2e8f0, transparent);
        }

        /* Success Message Animation */
        .success-pop {
            animation: successPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; filter: blur(10px); }
            100% { transform: scale(1); opacity: 1; filter: blur(0); }
        }

        #votedView {
            transition: background-color 0.8s ease;
        }

        #successOverlay {
            transition: background-color 0.5s ease, opacity 0.5s ease;
        }
    </style>
</head>
<body class="text-slate-900 pb-20 relative min-h-screen header-gradient">

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-6">
        <div class="glass-modal w-full max-w-xs p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <div class="text-center space-y-2">
                <div class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center mx-auto shadow-lg rotate-3 mb-2">
                    <i data-lucide="shield-lock" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-900 uppercase italic tracking-tighter">Admin</h3>
                <p class="text-slate-500 font-bold text-[10px] uppercase tracking-wider">Masukkan Password</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="adminPasswordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-white/50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none font-bold text-center tracking-widest transition-all">
                <div id="passwordError" class="hidden text-rose-500 text-center text-[10px] font-black uppercase tracking-tighter">Password Salah!</div>
                <div class="flex flex-col gap-2">
                    <button onclick="checkAdminPassword()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-600/20 transition-all uppercase text-xs">Masuk</button>
                    <button onclick="closePasswordModal()" class="w-full py-2 text-slate-400 font-bold text-[10px] uppercase hover:text-slate-600 transition-all">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay (No Box Version) -->
    <div id="successOverlay" class="fixed inset-0 z-[200] hidden flex flex-col items-center justify-center backdrop-blur-3xl transition-all duration-500">
        <div class="text-center space-y-10 success-pop">
            <div id="successEmojiDisplay" class="text-[12rem] animate-float drop-shadow-[0_25px_25px_rgba(0,0,0,0.15)]">ü§©</div>
            <div class="space-y-4">
                <h3 class="text-5xl font-black text-slate-900 tracking-tighter italic uppercase">BERHASIL!</h3>
                <p class="text-slate-700 font-bold text-xl">Suara kamu telah tersimpan secara anonim.</p>
            </div>
            <div class="w-24 h-1.5 bg-slate-900/10 mx-auto rounded-full"></div>
        </div>
    </div>

    <!-- FLOATING ADMIN BUTTON -->
    <div class="fixed bottom-6 right-6 z-[150] flex flex-col items-end gap-3">
        <div id="adminFabMenu" class="fab-hidden admin-fab-menu flex flex-col gap-3 mb-2">
            <button onclick="downloadReport()" class="flex items-center gap-3 bg-white text-indigo-600 font-bold px-5 py-3 rounded-2xl shadow-2xl border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all group">
                <span class="text-xs uppercase tracking-tight">Unduh</span>
                <div class="w-8 h-8 flex items-center justify-center bg-indigo-50 group-hover:bg-indigo-500 group-hover:text-white rounded-lg transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </div>
            </button>
            <button onclick="openDatabase()" class="flex items-center gap-3 bg-white text-emerald-600 font-bold px-5 py-3 rounded-2xl shadow-2xl border border-emerald-100 hover:bg-emerald-600 hover:text-white transition-all group">
                <span class="text-xs uppercase tracking-tight">Data</span>
                <div class="w-8 h-8 flex items-center justify-center bg-emerald-50 group-hover:bg-emerald-500 group-hover:text-white rounded-lg transition-colors">
                    <i data-lucide="database" class="w-4 h-4"></i>
                </div>
            </button>
            <button onclick="lockAdmin()" class="flex items-center gap-3 bg-slate-900 text-white font-bold px-5 py-3 rounded-2xl shadow-2xl hover:bg-black transition-all group">
                <span class="text-xs uppercase tracking-tight">Kunci</span>
                <div class="w-8 h-8 flex items-center justify-center bg-slate-800 group-hover:bg-slate-700 rounded-lg transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </div>
            </button>
        </div>
        
        <button id="mainFab" onclick="handleFabClick()" class="w-14 h-14 bg-slate-950 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all group">
            <i id="fabIcon" data-lucide="lock" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
        </button>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="max-w-5xl mx-auto px-6 pt-12 md:pt-20 space-y-16">
        <header class="text-center space-y-6">
            <div class="space-y-2">
                <div class="inline-block relative">
                    <h1 class="text-7xl md:text-9xl font-black tracking-tighter text-slate-950 leading-none">DINAMIS</h1>
                    <span class="absolute -bottom-1 -right-2 bg-indigo-600 text-white text-[10px] md:text-xs font-black px-3 py-1 rounded-full rotate-2 shadow-lg">BPS 1902</span>
                </div>
                <p class="text-slate-400 font-bold italic text-sm md:text-lg tracking-tight pt-4">"Dinamika Mingguan Internal Pegawai BPS"</p>
            </div>
        </header>

        <section id="pollingView" class="page-transition bg-white p-8 md:p-16 rounded-[4rem] shadow-2xl shadow-indigo-900/5 border border-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-full -mr-32 -mt-32 opacity-50"></div>
            <div class="relative z-10 space-y-12">
                <div class="space-y-6 max-w-2xl">
                    <h2 class="text-3xl md:text-5xl font-black text-slate-900 tracking-tight leading-[1.1]">Yuk, share cerita kerja kamu minggu ini üëã</h2>
                    <div class="space-y-1">
                        <p class="text-slate-500 font-bold text-base md:text-xl flex items-center gap-2">
                            <span>Singkat ‚úçÔ∏è, santai üòä, dan anonim üîí</span>
                        </p>
                    </div>
                </div>
                <div id="moodGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6"></div>
            </div>
        </section>

        <section id="votedView" class="hidden p-10 md:p-16 rounded-[4rem] text-white flex flex-col md:flex-row items-center justify-between gap-10 shadow-2xl">
            <div class="space-y-4 text-center md:text-left">
                <h3 class="text-4xl font-black italic uppercase tracking-tighter leading-none">Selesai!</h3>
                <p id="votedMessage" class="text-white/80 font-bold text-lg">Terima kasih atas partisipasi Anda.</p>
                <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-white/20 hover:bg-white/30 rounded-xl text-xs font-bold transition-all border border-white/30">Kirim Lagi</button>
            </div>
            <div id="votedEmojiDisplay" class="text-8xl animate-float"></div>
        </section>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-8 rounded-[3rem] border border-white shadow-sm flex items-center gap-6">
                <div class="p-5 bg-indigo-50 text-indigo-600 rounded-[2rem]"><i data-lucide="users-2"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Masuk</p>
                    <p id="statTotalVotes" class="text-3xl font-black text-slate-900">0</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[3rem] border border-white shadow-sm flex items-center gap-6">
                <div class="p-5 bg-emerald-50 text-emerald-600 rounded-[2rem]"><i data-lucide="clock"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Update Terakhir</p>
                    <p id="statLastUpdate" class="text-sm font-black text-slate-900">Menunggu...</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[3rem] border border-white shadow-sm flex items-center gap-6">
                <div class="p-5 bg-amber-50 text-amber-600 rounded-[2rem]"><i data-lucide="shield-check"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Status Keamanan</p>
                    <p class="text-sm font-black text-slate-900 uppercase">Anonim Terjaga</p>
                </div>
            </div>
        </div>

        <section class="bg-white p-10 md:p-16 rounded-[4rem] shadow-2xl shadow-indigo-900/5 border border-white">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                <div class="flex items-center gap-6">
                    <div class="p-5 bg-slate-950 text-white rounded-3xl shadow-xl rotate-3"><i data-lucide="bar-chart-big"></i></div>
                    <div>
                        <h2 class="text-3xl font-black text-slate-900 tracking-tight">Ringkasan Data</h2>
                        <p class="text-sm font-bold text-slate-400 italic">Distribusi polling pegawai minggu ini</p>
                    </div>
                </div>
                <div class="flex items-center bg-slate-100 p-1.5 rounded-2xl border border-slate-200 self-start md:self-center">
                    <button onclick="setChartType('bar')" id="btnChartBar" class="flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold text-xs uppercase tracking-tighter transition-all chart-toggle-active">
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                        <span>Bar</span>
                    </button>
                    <button onclick="setChartType('pie')" id="btnChartPie" class="flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold text-xs uppercase tracking-tighter transition-all text-slate-500 hover:text-slate-700">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i>
                        <span>Pie</span>
                    </button>
                </div>
            </div>
            <div class="relative h-[480px] w-full flex items-center justify-center">
                <canvas id="moodChart"></canvas>
            </div>
        </section>

        <footer class="pt-10 pb-20 text-center space-y-4">
            <div class="credit-line max-w-xs mx-auto opacity-20"></div>
            <div class="flex flex-col items-center">
                <p class="text-sm font-black text-slate-800 tracking-widest uppercase italic">BPS Kabupaten Belitung</p>
                <p class="mt-1 text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Tim Zona Integritas</p>
                <p class="mt-4 text-[9px] font-medium text-slate-300 uppercase tracking-widest">¬© 2026</p>
            </div>
        </footer>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_gy-pVOg7AqWvw840omAufQ1tuzyGpfTLhbBabtKTrycVvOX8T7dTSq-o_v1ORfBr/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1g2WfB6j6pEHc0q4iAb2FhSh_9QgWV42INagNuCVaiYU/edit?pli=1&gid=0#gid=0";

        Chart.register(ChartDataLabels);

        const MOOD_OPTIONS = [
            { id: 'excited', label: 'Semangat', emoji: 'ü§©', color: '#10B981' }, 
            { id: 'good', label: 'Senang', emoji: 'üòä', color: '#84CC16' },    
            { id: 'neutral', label: 'Biasa', emoji: 'üòê', color: '#94A3B8' },   
            { id: 'tired', label: 'Lelah', emoji: 'üò´', color: '#F59E0B' },     
            { id: 'burnout', label: 'Stress', emoji: 'ü§Ø', color: '#EF4444' }    
        ];

        let chartInstance = null;
        let chartType = 'bar';
        let lastStatsData = { total: 0, counts: {} };
        let isAdminUnlocked = false;
        let isFabMenuOpen = false;

        window.onload = () => {
            lucide.createIcons();
            renderMoodCards();
            refreshData(); 
            document.getElementById('adminPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkAdminPassword();
            });
        };

        function renderMoodCards() {
            const container = document.getElementById('moodGrid');
            if (!container) return;
            container.innerHTML = MOOD_OPTIONS.map(m => `
                <button onclick="voteMood('${m.id}')" class="mood-card group flex flex-col items-center justify-center p-8 md:p-10 rounded-[2.5rem] bg-slate-50 border-2 border-slate-100 hover:bg-white hover:border-indigo-500 hover:shadow-2xl transition-all">
                    <span class="text-6xl md:text-7xl mb-6 group-hover:scale-125 transition-transform duration-500">${m.emoji}</span>
                    <span class="block text-sm md:text-base font-black text-slate-800 uppercase tracking-tighter">${m.label}</span>
                </button>
            `).join('');
        }

        async function voteMood(moodId) {
            const mood = MOOD_OPTIONS.find(m => m.id === moodId);
            const successOverlay = document.getElementById('successOverlay');
            const pollingView = document.getElementById('pollingView');
            const votedView = document.getElementById('votedView');
            
            // Background color hint based on mood selection
            successOverlay.style.backgroundColor = `${mood.color}15`; 
            document.getElementById('successEmojiDisplay').innerText = mood.emoji;
            successOverlay.classList.remove('hidden');

            try {
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'addVote',
                        moodId: mood.id,
                        label: mood.label,
                        timestamp: new Date().toLocaleString('id-ID')
                    })
                });

                setTimeout(() => {
                    successOverlay.style.opacity = '0';
                    pollingView.classList.add('fade-out');
                    
                    setTimeout(() => {
                        successOverlay.classList.add('hidden');
                        successOverlay.style.opacity = '1';
                        pollingView.classList.add('hidden');
                        
                        votedView.style.backgroundColor = mood.color;
                        votedView.style.boxShadow = `0 25px 50px -12px ${mood.color}60`;
                        
                        votedView.classList.remove('hidden');
                        votedView.classList.add('fade-in');
                        document.getElementById('votedEmojiDisplay').innerText = mood.emoji;
                        
                        refreshData(); 
                    }, 500);
                }, 2000);

            } catch (err) {
                console.error("Error voting:", err);
                successOverlay.classList.add('hidden');
            }
        }

        async function refreshData() {
            if (!SCRIPT_URL || SCRIPT_URL.includes("MASUKKAN")) return;
            try {
                const fetchUrl = `${SCRIPT_URL}?action=getStats&t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl, { method: 'GET', redirect: 'follow' });
                if (!response.ok) throw new Error('Fetch stats failed');
                const stats = await response.json();
                lastStatsData = stats;
                document.getElementById('statTotalVotes').innerText = stats.total || 0;
                document.getElementById('statLastUpdate').innerText = new Date().toLocaleTimeString('id-ID');
                updateChart(stats.counts || {});
            } catch (err) {
                console.error("Gagal ambil data:", err);
                updateChart({});
            }
        }

        function setChartType(type) {
            if (chartType === type) return;
            chartType = type;
            const barBtn = document.getElementById('btnChartBar');
            const pieBtn = document.getElementById('btnChartPie');
            if (type === 'bar') {
                barBtn.classList.add('chart-toggle-active');
                barBtn.classList.remove('text-slate-500');
                pieBtn.classList.remove('chart-toggle-active');
                pieBtn.classList.add('text-slate-500');
            } else {
                pieBtn.classList.add('chart-toggle-active');
                pieBtn.classList.remove('text-slate-500');
                barBtn.classList.remove('chart-toggle-active');
                barBtn.classList.add('text-slate-500');
            }
            updateChart(lastStatsData.counts || {});
        }

        function updateChart(counts) {
            const chartCanvas = document.getElementById('moodChart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');
            const dataValues = MOOD_OPTIONS.map(m => counts[m.id] || 0);
            const total = dataValues.reduce((a, b) => a + b, 0);

            if (chartInstance) chartInstance.destroy();

            const chartConfig = {
                type: chartType,
                data: {
                    labels: MOOD_OPTIONS.map(m => m.emoji + ' ' + m.label),
                    datasets: [{
                        data: dataValues,
                        backgroundColor: MOOD_OPTIONS.map(m => m.color),
                        borderWidth: chartType === 'pie' ? 6 : 0,
                        borderColor: '#FFFFFF',
                        hoverOffset: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { 
                        padding: chartType === 'pie' ? { top: 20, bottom: 20, left: 20, right: 20 } : 0 
                    },
                    plugins: { 
                        legend: { 
                            display: chartType === 'pie',
                            position: 'bottom',
                            labels: { 
                                font: { weight: '800', family: "'Plus Jakarta Sans'", size: 15 },
                                padding: 40,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                color: '#1e293b'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleFont: { weight: 'bold', size: 14 },
                            bodyFont: { size: 14 },
                            padding: 18,
                            cornerRadius: 15,
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y || context.parsed || 0;
                                    const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                    return ` ${val} Suara (${pct}%)`;
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                return context.dataset.data[context.dataIndex] > 0;
                            },
                            color: '#FFFFFF',
                            font: { weight: '900', size: chartType === 'pie' ? 18 : 12, family: "'Plus Jakarta Sans'" },
                            formatter: (value, ctx) => {
                                if (total === 0) return '';
                                const percentage = ((value / total) * 100).toFixed(0) + '%';
                                return chartType === 'pie' ? percentage : value;
                            },
                            anchor: 'center',
                            align: 'center',
                            textShadowColor: 'rgba(0,0,0,0.5)',
                            textShadowBlur: 8
                        }
                    }
                }
            };

            if (chartType === 'bar') {
                chartConfig.options.scales = {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#f1f5f9' },
                        ticks: { stepSize: 1, color: '#94a3b8', font: { weight: 'bold' } } 
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#64748b', font: { weight: '800', size: 11 } } 
                    }
                };
                chartConfig.data.datasets[0].borderRadius = 25;
                chartConfig.options.plugins.datalabels.anchor = 'end';
                chartConfig.options.plugins.datalabels.align = 'top';
                chartConfig.options.plugins.datalabels.color = '#64748b';
            } else {
                chartConfig.options.cutout = '45%'; 
            }

            chartInstance = new Chart(ctx, chartConfig);
        }

        function handleFabClick() {
            if (!isAdminUnlocked) openPasswordModal();
            else toggleFabMenu();
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('adminPasswordInput').focus();
            document.getElementById('passwordError').classList.add('hidden');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('adminPasswordInput').value = '';
        }

        function checkAdminPassword() {
            const input = document.getElementById('adminPasswordInput');
            if (input.value === "dinamis1902") {
                isAdminUnlocked = true;
                closePasswordModal();
                unlockAdminUI();
            } else {
                document.getElementById('passwordError').classList.remove('hidden');
                input.value = '';
                input.focus();
            }
        }

        function unlockAdminUI() {
            const icon = document.getElementById('fabIcon');
            const fab = document.getElementById('mainFab');
            icon.setAttribute('data-lucide', 'settings');
            fab.classList.replace('bg-slate-950', 'bg-indigo-600');
            lucide.createIcons();
            toggleFabMenu(); 
        }

        function toggleFabMenu() {
            const menu = document.getElementById('adminFabMenu');
            isFabMenuOpen = !isFabMenuOpen;
            menu.classList.toggle('fab-hidden', !isFabMenuOpen);
            document.getElementById('fabIcon').style.transform = isFabMenuOpen ? 'rotate(90deg)' : 'rotate(0deg)';
        }

        function lockAdmin() {
            isAdminUnlocked = false;
            isFabMenuOpen = false;
            document.getElementById('adminFabMenu').classList.add('fab-hidden');
            const icon = document.getElementById('fabIcon');
            const fab = document.getElementById('mainFab');
            icon.setAttribute('data-lucide', 'lock');
            fab.classList.replace('bg-indigo-600', 'bg-slate-950');
            lucide.createIcons();
        }

        function openDatabase() {
            if (SHEET_URL && SHEET_URL.startsWith('http')) {
                window.open(SHEET_URL, '_blank');
            } else {
                alert("URL Database belum dikonfigurasi.");
            }
            toggleFabMenu();
        }

        function downloadReport() {
            if (!lastStatsData || lastStatsData.total === 0) {
                alert("Belum ada data untuk diunduh.");
                return;
            }
            const header = "Kategori,Jumlah,Persentase\n";
            const rows = MOOD_OPTIONS.map(m => {
                const count = lastStatsData.counts[m.id] || 0;
                const pct = ((count / lastStatsData.total) * 100).toFixed(2);
                return `${m.label},${count},${pct}%`;
            }).join("\n");
            const csvContent = "data:text/csv;charset=utf-8," + header + rows;
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `rekap_bps_${new Date().toLocaleDateString()}.csv`);
            link.click();
            toggleFabMenu(); 
        }
    </script>
</body>
</html>
