<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DINAMIS BPS - Mood Polling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F8FAFC;
        }

        .mood-card {
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .mood-card:hover {
            transform: translateY(-12px);
            border-color: rgba(79, 70, 229, 0.4);
            background: white;
            box-shadow: 0 25px 50px -12px rgba(79, 70, 229, 0.15);
        }

        .header-gradient {
            background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.1), transparent),
                        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.05), transparent);
        }

        .animate-float { animation: float 4s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        .page-transition {
            transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .fade-out {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.8s forwards cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-modal {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="text-slate-900 pb-20 relative min-h-screen header-gradient">

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-6">
        <div class="glass-modal w-full max-w-xs p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <div class="text-center space-y-2">
                <div class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center mx-auto shadow-lg rotate-3 mb-2">
                    <i data-lucide="shield-lock" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-900 uppercase italic tracking-tighter">Admin</h3>
                <p class="text-slate-500 font-bold text-[10px] uppercase tracking-wider">Masukkan Password</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="adminPasswordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-white/50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none font-bold text-center tracking-widest transition-all">
                <div id="passwordError" class="hidden text-rose-500 text-center text-[10px] font-black uppercase tracking-tighter">Password Salah!</div>
                <div class="flex flex-col gap-2">
                    <button onclick="checkAdminPassword()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-600/20 transition-all uppercase text-xs">Masuk</button>
                    <button onclick="closePasswordModal()" class="w-full py-2 text-slate-400 font-bold text-[10px] uppercase hover:text-slate-600 transition-all">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="successOverlay" class="fixed inset-0 z-[200] hidden flex flex-col items-center justify-center backdrop-blur-3xl transition-all duration-500">
        <div class="text-center space-y-10 animate-pulse">
            <div id="successEmojiDisplay" class="text-[12rem] animate-float drop-shadow-[0_25px_25px_rgba(0,0,0,0.15)]">ü§©</div>
            <div class="space-y-4">
                <h3 class="text-5xl font-black text-slate-900 tracking-tighter italic uppercase">BERHASIL!</h3>
                <p class="text-slate-700 font-bold text-xl">Suara kamu telah tersimpan secara anonim.</p>
            </div>
        </div>
    </div>

    <!-- FLOATING ADMIN BUTTON -->
    <div class="fixed bottom-6 right-6 z-[150] flex flex-col items-end gap-3">
        <div id="adminFabMenu" class="hidden flex flex-col gap-3 mb-2 scale-0 origin-bottom-right transition-all duration-300">
            <button id="btnToggleVote" onclick="toggleVoteStatus()" class="flex items-center gap-3 bg-white text-rose-600 font-bold px-5 py-3 rounded-2xl shadow-2xl border border-rose-100 hover:bg-rose-600 hover:text-white transition-all">
                <span id="txtToggleVote" class="text-xs uppercase tracking-tight">Tutup Vote</span>
                <i id="iconToggleVote" data-lucide="circle-stop" class="w-4 h-4"></i>
            </button>
            <button onclick="downloadReportCSV()" class="flex items-center gap-3 bg-white text-indigo-600 font-bold px-5 py-3 rounded-2xl shadow-2xl border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all group">
                <span class="text-xs uppercase tracking-tight">Unduh CSV</span>
                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
            </button>
            <button onclick="openDatabase()" class="flex items-center gap-3 bg-white text-emerald-600 font-bold px-5 py-3 rounded-2xl shadow-2xl border border-emerald-100 hover:bg-emerald-600 hover:text-white transition-all group">
                <span class="text-xs uppercase tracking-tight">Data</span>
                <i data-lucide="database" class="w-4 h-4"></i>
            </button>
            <button onclick="lockAdmin()" class="flex items-center gap-3 bg-slate-900 text-white font-bold px-5 py-3 rounded-2xl shadow-2xl hover:bg-black transition-all">
                <span class="text-xs uppercase tracking-tight">Kunci</span>
                <i data-lucide="log-out" class="w-4 h-4"></i>
            </button>
        </div>
        
        <button id="mainFab" onclick="handleFabClick()" class="w-14 h-14 bg-slate-950 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all group">
            <i id="fabIcon" data-lucide="lock" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
        </button>
    </div>

    <!-- MAIN APP -->
    <div class="max-w-5xl mx-auto px-6 pt-12 md:pt-20 space-y-12">
        <header class="text-center space-y-6">
            <div class="space-y-2">
                <div class="inline-block relative">
                    <h1 class="text-7xl md:text-9xl font-black tracking-tighter text-slate-950 leading-none">DINAMIS</h1>
                    <span class="absolute -bottom-1 -right-2 bg-indigo-600 text-white text-[10px] md:text-xs font-black px-3 py-1 rounded-full rotate-2 shadow-lg">BPS 1902</span>
                </div>
                <p class="text-slate-400 font-bold italic text-sm md:text-lg tracking-tight pt-4">"Dinamika Mingguan Internal Pegawai BPS"</p>
            </div>
        </header>

        <section id="pollingView" class="page-transition bg-white p-8 md:p-16 rounded-[4rem] shadow-2xl shadow-indigo-900/5 border border-white relative overflow-hidden">
            <div class="relative z-10 space-y-12">
                <div id="activePollHeader" class="space-y-6 max-w-2xl">
                    <h2 class="text-3xl md:text-5xl font-black text-slate-900 tracking-tight leading-[1.1]">Yuk, share cerita kerja kamu minggu ini üëã</h2>
                    <p class="text-slate-500 font-bold text-base md:text-xl">Singkat ‚úçÔ∏è, santai üòä, dan anonim üîí</p>
                </div>
                
                <div id="moodGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6"></div>
                
                <div id="closedPollView" class="hidden py-20 text-center space-y-6">
                    <div class="text-8xl animate-float">üîí</div>
                    <h2 class="text-4xl font-black text-slate-900 uppercase italic tracking-tighter">Voting Ditutup</h2>
                    <p class="text-slate-500 font-bold">Polling saat ini sudah tidak menerima jawaban.</p>
                </div>
            </div>
        </section>

        <!-- View Setelah Voting -->
        <div id="votedContainer" class="hidden space-y-6 fade-in">
            <!-- Box Selesai -->
            <section id="votedView" class="p-10 md:p-14 rounded-[3.5rem] text-white flex flex-col md:flex-row items-center justify-between gap-10 shadow-2xl relative overflow-hidden">
                <div class="space-y-2 text-center md:text-left z-10">
                    <h3 class="text-4xl md:text-5xl font-black italic uppercase tracking-tighter">Selesai!</h3>
                    <p class="text-white/90 font-bold text-lg md:text-xl">Terima kasih atas partisipasi Anda.</p>
                </div>
                <div id="votedEmojiDisplay" class="text-8xl md:text-[8rem] animate-float z-10"></div>
                <!-- Background Accent -->
                <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
            </section>

            <!-- Bagian Aspirasi (Penuh & Memanjang) -->
            <section class="bg-indigo-50/50 border-2 border-indigo-100 p-8 md:p-10 rounded-[3.5rem] text-center space-y-6">
                <div class="max-w-3xl mx-auto">
                    <p class="text-indigo-950 font-bold text-base md:text-xl leading-relaxed">
                        Kalau emoji belum cukup mewakili, kamu bisa lanjutkan ceritanya lewat <span class="text-indigo-600">Suara Online</span> pegawai di sini üëá
                    </p>
                </div>
                
                <!-- Tombol Suara Full Width Modern -->
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSeIaR5_ECuGVJmn4pnRwv4GFWOSTkeCPjLmtjmHBTVGjsVlyw/viewform?usp=dialog" target="_blank" 
                   class="flex items-center justify-between gap-4 bg-indigo-600 text-white p-2.5 pl-6 md:pl-8 rounded-[2.5rem] hover:bg-indigo-700 hover:scale-[1.01] active:scale-[0.99] transition-all shadow-xl shadow-indigo-200 group w-full overflow-hidden">
                    
                    <div class="flex flex-col items-start leading-none py-2 md:py-4">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl md:text-5xl font-black tracking-tighter uppercase italic">SUARA</span>
                            <span class="text-2xl md:text-5xl font-black tracking-tighter uppercase italic text-indigo-300">ONLINE</span>
                        </div>
                        <span class="text-[8px] md:text-[10px] font-bold uppercase tracking-[0.2em] text-indigo-100 mt-1 opacity-80 whitespace-nowrap">
                            Saling Ungkap Aspirasi Online
                        </span>
                    </div>

                    <div class="w-14 h-14 md:w-20 md:h-20 bg-white/10 rounded-[1.8rem] md:rounded-[2.2rem] flex items-center justify-center group-hover:bg-white/20 transition-all flex-shrink-0">
                        <i data-lucide="message-square-plus" class="w-6 h-6 md:w-10 md:h-10 text-white group-hover:scale-110 transition-transform"></i>
                    </div>
                </a>
            </section>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-8 rounded-[3rem] shadow-sm flex items-center gap-6 border border-slate-50">
                <div class="p-5 bg-indigo-50 text-indigo-600 rounded-[2rem]"><i data-lucide="users-2"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Masuk</p>
                    <p id="statTotalVotes" class="text-3xl font-black text-slate-900 tracking-tight">0</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[3rem] shadow-sm flex items-center gap-6 border border-slate-50">
                <div class="p-5 bg-emerald-50 text-emerald-600 rounded-[2rem]"><i data-lucide="clock"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Update Terakhir</p>
                    <p id="statLastUpdate" class="text-sm font-black text-slate-900 tracking-tight uppercase">--:--</p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-[3rem] shadow-sm flex items-center gap-6 border border-slate-50">
                <div id="statusIconBg" class="p-5 bg-amber-50 text-amber-600 rounded-[2rem]"><i id="statusIcon" data-lucide="shield-check"></i></div>
                <div>
                    <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">Status Polling</p>
                    <p id="statPollStatus" class="text-sm font-black text-slate-900 uppercase tracking-wide">Terbuka</p>
                </div>
            </div>
        </div>

        <!-- Section Ringkasan Data -->
        <section class="bg-white p-10 md:p-16 rounded-[4rem] shadow-2xl shadow-indigo-900/5 border border-white">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-6">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-indigo-600 text-white rounded-2xl shadow-lg">
                        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-4xl font-black text-slate-950 tracking-tighter italic uppercase">Ringkasan Data</h2>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mt-1">Visualisasi Polling Mingguan</p>
                    </div>
                </div>
                <div class="flex items-center bg-slate-100 p-1.5 rounded-2xl">
                    <button onclick="setChartType('bar')" id="btnChartBar" class="px-5 py-2.5 rounded-xl font-bold text-xs uppercase transition-all bg-indigo-600 text-white shadow-lg">Bar Chart</button>
                    <button onclick="setChartType('pie')" id="btnChartPie" class="px-5 py-2.5 rounded-xl font-bold text-xs uppercase transition-all text-slate-500 hover:text-indigo-600">Donut Pie</button>
                </div>
            </div>
            
            <div class="relative h-[320px] w-full flex items-center justify-center">
                <canvas id="moodChart"></canvas>
            </div>

            <div class="mt-2 border-t border-slate-100 pt-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 text-center">Rincian Vote Mingguan</p>
                <div id="voteDetailsList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3"></div>
            </div>
        </section>

        <footer class="pt-10 pb-20 text-center flex flex-col items-center justify-center space-y-4">
            <img src="https://upload.wikimedia.org/wikipedia/commons/2/28/Lambang_Badan_Pusat_Statistik_%28BPS%29_Indonesia.svg" alt="Logo BPS" class="h-10 w-auto opacity-70">
            <div class="space-y-1">
                <p class="text-sm font-black text-slate-800 tracking-widest uppercase italic">BPS Kabupaten Belitung</p>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">TIM ZONA INTEGRITAS</p>
            </div>
        </footer>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjGhLyg0vVuuPfDrb_XKH8ttAKi4jL4CoEXvXfCbmN_Rk84GiFRNHfhcvZaWL7NHZ3/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1g2WfB6j6pEHc0q4iAb2FhSh_9QgWV42INagNuCVaiYU/edit?usp=sharing";
        
        Chart.register(ChartDataLabels);

        const MOOD_OPTIONS = [
            { id: 'excited', label: 'Semangat', emoji: 'ü§©', color: '#10B981', shadow: 'rgba(16, 185, 129, 0.4)' }, 
            { id: 'good', label: 'Senang', emoji: 'üòä', color: '#84CC16', shadow: 'rgba(132, 204, 22, 0.4)' },    
            { id: 'neutral', label: 'Biasa', emoji: 'üòê', color: '#94A3B8', shadow: 'rgba(148, 163, 184, 0.4)' },   
            { id: 'tired', label: 'Lelah', emoji: 'üò´', color: '#F59E0B', shadow: 'rgba(245, 158, 11, 0.4)' },     
            { id: 'burnout', label: 'Stress', emoji: 'ü§Ø', color: '#EF4444', shadow: 'rgba(239, 68, 68, 0.4)' }    
        ];

        let chartInstance = null;
        let chartType = 'bar';
        let lastStatsData = { total: 0, counts: {}, isVoteOpen: true };
        let isAdminUnlocked = false;
        let isVoteOpen = true;

        window.onload = () => {
            lucide.createIcons();
            renderMoodCards();
            refreshData(); 
            setInterval(refreshData, 10000);
        };

        function renderMoodCards() {
            const container = document.getElementById('moodGrid');
            if (!container) return;
            container.innerHTML = MOOD_OPTIONS.map(m => `
                <button onclick="voteMood('${m.id}')" 
                    style="--tw-shadow-color: ${m.shadow}"
                    class="mood-card group flex flex-col items-center justify-center p-8 md:p-10 rounded-[2.5rem] bg-slate-50 border-2 border-slate-100 transition-all">
                    <div class="emoji-box text-6xl md:text-7xl mb-6 z-10">${m.emoji}</div>
                    <span class="text-sm md:text-base font-black text-slate-800 uppercase tracking-tighter">${m.label}</span>
                </button>
            `).join('');
        }

        async function voteMood(moodId) {
            if (!isVoteOpen) return;
            const mood = MOOD_OPTIONS.find(m => m.id === moodId);
            const overlay = document.getElementById('successOverlay');
            document.getElementById('successEmojiDisplay').innerText = mood.emoji;
            overlay.classList.remove('hidden');

            try {
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'addVote', moodId: mood.id, label: mood.label })
                });

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    document.getElementById('pollingView').classList.add('fade-out');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        document.getElementById('pollingView').classList.add('hidden');
                        
                        const votedContainer = document.getElementById('votedContainer');
                        const votedView = document.getElementById('votedView');
                        
                        votedView.style.backgroundColor = mood.color;
                        votedContainer.classList.remove('hidden');
                        document.getElementById('votedEmojiDisplay').innerText = mood.emoji;
                        
                        lucide.createIcons();
                        refreshData();
                    }, 500);
                }, 1800);
            } catch (e) { console.error(e); }
        }

        async function refreshData() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStats`);
                const stats = await response.json();
                lastStatsData = stats;
                
                if (typeof stats.isVoteOpen !== 'undefined') {
                    isVoteOpen = stats.isVoteOpen;
                    applyVoteStatusUI();
                }

                document.getElementById('statTotalVotes').innerText = stats.total || 0;
                document.getElementById('statLastUpdate').innerText = new Date().toLocaleTimeString('id-ID');
                updateChart(stats.counts || {});
                renderVoteDetails(stats.counts || {});
            } catch (e) { console.error(e); }
        }

        function renderVoteDetails(counts) {
            const list = document.getElementById('voteDetailsList');
            list.innerHTML = MOOD_OPTIONS.map(m => `
                <div class="flex flex-col items-center justify-center p-3 bg-slate-50 rounded-2xl border border-slate-100 transition-all hover:bg-white hover:shadow-md">
                    <span class="text-xl mb-1">${m.emoji}</span>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1 text-center">${m.label}</span>
                    <span class="text-lg font-black text-slate-900">${counts[m.id] || 0}</span>
                </div>
            `).join('');
        }

        function updateChart(counts) {
            const canvas = document.getElementById('moodChart');
            const ctx = canvas.getContext('2d');
            const dataValues = MOOD_OPTIONS.map(m => counts[m.id] || 0);
            const total = dataValues.reduce((a, b) => a + b, 0);

            if (chartInstance) chartInstance.destroy();

            const actualChartType = chartType === 'pie' ? 'doughnut' : 'bar';

            chartInstance = new Chart(ctx, {
                type: actualChartType,
                data: {
                    labels: MOOD_OPTIONS.map(m => m.label),
                    datasets: [{
                        data: dataValues,
                        backgroundColor: MOOD_OPTIONS.map(m => m.color),
                        borderRadius: 12,
                        borderWidth: 0,
                        hoverOffset: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1000 },
                    plugins: {
                        legend: { 
                            display: chartType === 'pie',
                            position: 'bottom',
                            labels: {
                                font: { weight: '700', family: 'Plus Jakarta Sans', size: 10 },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: { enabled: true },
                        datalabels: {
                            display: true,
                            color: '#ffffff',
                            backgroundColor: (ctx) => ctx.dataset.backgroundColor[ctx.dataIndex],
                            borderRadius: 4,
                            padding: 4,
                            font: {
                                weight: '800',
                                family: 'Plus Jakarta Sans',
                                size: chartType === 'pie' ? 12 : 10
                            },
                            formatter: (value) => {
                                if (value === 0) return null;
                                let perc = (value * 100 / (total || 1)).toFixed(1) + "%";
                                return chartType === 'pie' ? perc : value + ' (' + perc + ')';
                            },
                            anchor: 'center',
                            align: 'center',
                            opacity: 1
                        }
                    },
                    cutout: chartType === 'pie' ? '60%' : '0%',
                    scales: chartType === 'bar' ? {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#F1F5F9', drawBorder: false }, 
                            ticks: { font: { weight: '600', family: 'Plus Jakarta Sans' }, color: '#94A3B8' },
                            grace: '15%'
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: { weight: '800', size: 10, family: 'Plus Jakarta Sans' }, color: '#475569' } 
                        }
                    } : {}
                }
            });
        }

        function setChartType(type) {
            chartType = type;
            document.getElementById('btnChartBar').className = type === 'bar' ? 'px-5 py-2.5 rounded-xl font-bold text-xs uppercase bg-indigo-600 text-white shadow-lg' : 'px-5 py-2.5 rounded-xl font-bold text-xs uppercase text-slate-500 hover:text-indigo-600';
            document.getElementById('btnChartPie').className = type === 'pie' ? 'px-5 py-2.5 rounded-xl font-bold text-xs uppercase bg-indigo-600 text-white shadow-lg' : 'px-5 py-2.5 rounded-xl font-bold text-xs uppercase text-slate-500 hover:text-indigo-600';
            updateChart(lastStatsData.counts || {});
        }

        function applyVoteStatusUI() {
            const statStatus = document.getElementById('statPollStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusIconBg = document.getElementById('statusIconBg');
            
            if (isVoteOpen) {
                document.getElementById('moodGrid')?.classList.remove('hidden');
                document.getElementById('closedPollView')?.classList.add('hidden');
                statStatus.innerText = "Terbuka";
                statusIconBg.className = "p-5 bg-amber-50 text-amber-600 rounded-[2rem]";
                statusIcon.setAttribute('data-lucide', 'shield-check');
            } else {
                document.getElementById('moodGrid')?.classList.add('hidden');
                document.getElementById('closedPollView')?.classList.remove('hidden');
                statStatus.innerText = "Ditutup";
                statusIconBg.className = "p-5 bg-rose-50 text-rose-600 rounded-[2rem]";
                statusIcon.setAttribute('data-lucide', 'lock');
            }
            lucide.createIcons();
        }

        function handleFabClick() {
            if (!isAdminUnlocked) document.getElementById('passwordModal').classList.remove('hidden');
            else toggleFabMenu();
        }

        function checkAdminPassword() {
            if (document.getElementById('adminPasswordInput').value === "dinamis1902") {
                isAdminUnlocked = true;
                document.getElementById('passwordModal').classList.add('hidden');
                document.getElementById('fabIcon').setAttribute('data-lucide', 'settings');
                document.getElementById('mainFab').classList.replace('bg-slate-950', 'bg-indigo-600');
                lucide.createIcons();
                toggleFabMenu();
            } else {
                document.getElementById('passwordError').classList.remove('hidden');
            }
        }

        function toggleFabMenu() {
            const menu = document.getElementById('adminFabMenu');
            menu.classList.toggle('hidden');
            setTimeout(() => menu.classList.toggle('scale-100'), 10);
        }

        function closePasswordModal() { document.getElementById('passwordModal').classList.add('hidden'); }
        function lockAdmin() { location.reload(); }
        function openDatabase() { window.open(SHEET_URL, '_blank'); }

        function downloadReportCSV() {
            const counts = lastStatsData.counts || {};
            const total = lastStatsData.total || 0;
            const now = new Date();
            let csvContent = "Kategori,Jumlah Suara,Persentase\n";
            MOOD_OPTIONS.forEach(m => {
                const count = counts[m.id] || 0;
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                csvContent += `${m.label},${count},${percent}%\n`;
            });
            csvContent += `\nTotal Keseluruhan,${total},100%\n`;
            csvContent += `Waktu Unduh: ${now.toLocaleString('id-ID')}\n`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Rekapan_Dinamis_BPS_${now.toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function toggleVoteStatus() {
            const newStatus = !isVoteOpen;
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'toggleVote', isOpen: newStatus }) });
            isVoteOpen = newStatus;
            applyVoteStatusUI();
            toggleFabMenu();
        }
    </script>
</body>
</html>
